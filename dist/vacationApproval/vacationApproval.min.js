/*! node-form-app 29-07-2014 */
var VacationApproval;!function(a){var b=function(){function a(){this.tagName="dateCompareExt"}return a.prototype.isAcceptable=function(a){if(!_.isDate(a))return!1;var b=moment(a);void 0==this.From&&(this.From=new Date);var c=moment(this.From);void 0==this.To&&(this.To=new Date);var d=moment(this.To),e=this.isValid(c,b,this.FromOperator)&&this.isValid(d,b,this.ToOperator);return e},a.prototype.isValid=function(a,b,c){var d=!1;this.IgnoreTime&&(b=b.startOf("day"),a=a.startOf("day"));var e=b.diff(a);return this.IgnoreTime&&(e=moment.duration(e).days()),d=0>e?0==c||1==c||3==c:e>0?5==c||4==c||3==c:1==c||2==c||4==c},a.prototype.customMessage=function(a,b){var c=a.Msg,d=a.Format;return void 0!=d&&_.extend(b,{FormatedFrom:moment(b.From).format(d),FormatedTo:moment(b.To).format(d),FormatedAttemptedValue:moment(b.AttemptedValue).format(d)}),c=c.replace("From","FormatedFrom"),c=c.replace("To","FormatedTo"),c=c.replace("AttemptedValue","FormatedAttemptedValue"),Validation.StringFce.format(c,b)},a}();a.FromToDateValidator=b}(VacationApproval||(VacationApproval={}));var VacationApproval;!function(a){var b=function(){function a(){this.tagName="isWeekday"}return a.prototype.isAcceptable=function(a){if(!_.isDate(a))return!1;var b=moment(a);return!(6==b.isoWeekday()||7==b.isoWeekday())},a}();a.IsWeekdayValidator=b}(VacationApproval||(VacationApproval={}));var VacationApproval;!function(a){var b=function(){function b(a){this.DataProvider=a,_.mixin({contains:function(a,b){return null==a?!1:(a.length!==+a.length&&(a=_.values(a)),_.every(a,function(a){return moment.isMoment(a)})?_.any(a,function(a){return a.isSame(b)}):_.indexOf(a,b)>=0)}})}return Object.defineProperty(b.prototype,"Data",{get:function(){return this.DataProvider.Duration},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"FromDatePart",{get:function(){return moment(this.Data.From).startOf("days")},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"ToDatePart",{get:function(){return moment(this.Data.To).startOf("days")},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"ExcludedDaysDatePart",{get:function(){return _.map(this.Data.ExcludedDays,function(a){return moment(a).startOf("days")})},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"FromRange",{get:function(){return moment().range(this.FromDatePart,this.ToDatePart)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"RangeDaysCount",{get:function(){return this.RangeDays.length},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"RangeDays",{get:function(){var a=[];return this.FromRange.by("days",function(b){a.push(b)}),a},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"ExcludedWeekdaysCount",{get:function(){return this.ExcludedWeekdays.length},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"ExcludedWeekdays",{get:function(){var a=[];return this.FromRange.by("days",function(b){(6==b.isoWeekday()||7==b.isoWeekday())&&a.push(b)}),a},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"ExcludedDaysCount",{get:function(){return this.ExcludedDays.length},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"ExcludedDays",{get:function(){return void 0==this.Data.ExcludedDays||0==this.Data.ExcludedDays.length?this.ExcludedWeekdays:_.union(this.ExcludedWeekdays,this.ExcludedDaysDatePart)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"VacationDaysCount",{get:function(){return this.VacationDays.length},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"VacationDays",{get:function(){return _.difference(this.RangeDays,this.ExcludedDays)},enumerable:!0,configurable:!0}),b.prototype.createDurationValidator=function(){var b=new Validation.AbstractValidator,c=new Validation.RequiredValidator,d=new a.FromToDateValidator,e=new a.IsWeekdayValidator;d.FromOperator=4,d.From=new Date,d.ToOperator=1,d.To=moment(new Date).add({year:1}).toDate(),d.IgnoreTime=!0,b.RuleFor("From",c),b.RuleFor("To",c),b.RuleFor("From",e),b.RuleFor("To",e),b.RuleFor("From",d),b.RuleFor("To",d);var f=function(a,b){var c=a.Msg,d=a.Format;return void 0!=d&&_.extend(b,{FormatedFrom:moment(b.From).format(d),FormatedTo:moment(b.To).format(d),FormatedAttemptedValue:moment(b.AttemptedValue).format(d)}),c=c.replace("From","FormatedFrom"),c=c.replace("To","FormatedTo"),c=c.replace("AttemptedValue","FormatedAttemptedValue"),Validation.StringFce.format(c,b)},g=this,h=function(a){if(a.HasError=!1,a.ErrorMessage="",_.isDate(this.From)&&_.isDate(this.To)){if(g.FromDatePart.isAfter(g.ToDatePart))return a.HasError=!0,a.ErrorMessage=f({Msg:"Date from '{From}' must be before date to '{To}'.",Format:"MM/DD/YYYY"},this),void(a.TranslateArgs={TranslateId:"BeforeDate",MessageArgs:this,CustomMessage:f});var b=25;if(g.VacationDaysCount>b){a.HasError=!0;var c={MaxDays:b};a.ErrorMessage=Validation.StringFce.format("Maximal vacation duration is {MaxDays}'.",c),a.TranslateArgs={TranslateId:"MaxDuration",MessageArgs:c}}var d=_.difference(g.ExcludedDaysDatePart,g.RangeDays);if(0!=d.length){a.HasError=!0;var e={ExcludedDates:_.reduce(d,function(a,b){return a+b.format("MM/DD/YYYY")})};a.ErrorMessage=Validation.StringFce.format("Excluded days are not in range. '{ExcludedDates}'.",e),a.TranslateArgs={TranslateId:"ExcludedDays",MessageArgs:e}}}},i={Name:"VacationDuration",ValidationFce:h};return b.ValidationFor("From",i),b.ValidationFor("To",i),b},b}();a.Duration=b}(VacationApproval||(VacationApproval={}));var VacationApproval;!function(a){var b=function(){function b(b,c){this.Data=b,this.vacationDeputyService=c,this.Duration=new a.Duration(this.Data),this.MainValidator=this.createMainValidator().CreateRule("Data"),this.EmployeeValidator=this.MainValidator.Children.Employee,this.Deputy1Validator=this.MainValidator.Children.Deputy1,this.Deputy2Validator=this.MainValidator.Children.Deputy2,this.DurationValidator=this.MainValidator.Children.Duration,this.DeputyConflictsValidator=this.MainValidator.Validators.DeputyConflict,this.EmployeeValidator.Rules.Email.Optional=function(){return void 0==this.Email||!this.Email.Checked}.bind(this.Data.Employee),this.Deputy2Validator.SetOptional(function(){return void 0==this.Deputy2||!this.Deputy2.Checked}.bind(this.Data)),this.Errors=this.MainValidator.ValidationResult}return b.prototype.Validate=function(){this.MainValidator.ValidateAll(this.Data),this.DeputyConflictsValidator.ValidateAsync(this.Data)},b.prototype.DeputyConflictsValidatorValidateAsync=function(){return this.DeputyConflictsValidator.ValidateAsync(this.Data)},b.prototype.createMainValidator=function(){var a=new Validation.AbstractValidator,b=this.createPersonValidator();a.ValidatorFor("Employee",b),a.ValidatorFor("Deputy1",b),a.ValidatorFor("Deputy2",b);var c=this.Duration.createDurationValidator();a.ValidatorFor("Duration",c);var d=this.vacationDeputyService,e=function(a){var b=Q.defer();return d.isAcceptable(this).then(function(c){a.HasError=!1,a.ErrorMessage="",c||(a.HasError=!0,a.ErrorMessage="Deputies conflict. Select another deputy."),b.resolve(void 0)}),b.promise},f={Name:"DeputyConflict",AsyncValidationFce:e};return a.ValidationFor("DeputyConflict",f),a},b.prototype.createPersonValidator=function(){var a=new Validation.AbstractValidator,b=new Validation.RequiredValidator,c=new Validation.EmailValidator,d=new Validation.MaxLengthValidator;return d.MaxLength=15,a.RuleFor("FirstName",b),a.RuleFor("FirstName",d),a.RuleFor("LastName",b),a.RuleFor("LastName",d),a.RuleFor("Email",b),a.RuleFor("Email",c),a},b}();a.BusinessRules=b}(VacationApproval||(VacationApproval={}));